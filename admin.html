<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin Dashboard</title>
<style>body{font-family:system-ui;padding:20px}table{border-collapse:collapse;width:100%;margin-top:12px}th,td{border:1px solid #ddd;padding:8px;font-size:14px}th{background:#f4f4f4;text-align:left}.pill{padding:2px 8px;border-radius:999px;font-size:12px}.pending{background:#fee2e2}.ok{background:#d1fae5}</style>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
</head><body>
<h1>Admin Dashboard</h1>
<div id="me"></div>

<h2>待審核使用者</h2>
<table id="tbl-users"><thead><tr><th>Email</th><th>Name</th><th>狀態</th><th>操作</th></tr></thead><tbody></tbody></table>

<h2 style="margin-top:24px">最新作答紀錄</h2>
<table id="tbl-attempts"><thead><tr><th>時間</th><th>學生</th><th>類別</th><th>分數</th><th>題數</th></tr></thead><tbody></tbody></table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyASbUFTuAh3vbK0BFZG6hwQQOxJrCuya9w",
  authDomain: "test-d72ca.firebaseapp.com",
  projectId: "test-d72ca",
  storageBucket: "test-d72ca.firebasestorage.app",
  messagingSenderId: "374104132874",
  appId: "1:374104132874:web:05b3a36b8855b560063ef3",
  measurementId: "G-LP77MNJJVZ"
};  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth(); const db = firebase.firestore();

  async function assertAdmin(user){
    const u = await db.collection('users').doc(user.uid).get();
    if (u.data()?.role !== 'admin') { alert('非管理者'); location.href = '/'; throw new Error('not admin'); }
    document.getElementById('me').textContent = `管理者：${user.email}`;
  }
  async function loadPending(){
    const qs = await db.collection('users').where('approved','==',false).get();
    const tbody = document.querySelector('#tbl-users tbody'); tbody.innerHTML='';
    qs.forEach(doc=>{
      const d=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${d.email||''}</td><td>${d.displayName||''}</td>
        <td><span class="pill pending">Pending</span></td>
        <td><button data-uid="${doc.id}">核可</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.onclick = async e=>{
      const uid = e.target?.dataset?.uid; if(!uid) return;
      await db.collection('users').doc(uid).update({approved:true});
      loadPending(); loadAttempts();
    };
  }
  async function loadAttempts(){
    const qs = await db.collection('attempts').orderBy('createdAt','desc').limit(50).get();
    const tbody = document.querySelector('#tbl-attempts tbody'); tbody.innerHTML='';
    qs.forEach(doc=>{
      const a=doc.data(); const t=a.createdAt?.toDate?.()||new Date();
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${t.toLocaleString()}</td><td>${a.userName||a.uid}</td>
        <td>${a.category}</td><td>${a.score}</td><td>${a.total}</td>`;
      tbody.appendChild(tr);
    });
  }
  auth.onAuthStateChanged(async (user)=>{
    if(!user) return location.href='/';
    await assertAdmin(user); loadPending(); loadAttempts();
  });
</script>
</body></html>
